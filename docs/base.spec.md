# Tarot Manager
Web application that allows a user to generate and track their tarot readings.  Readings can be entered manually or generated by the application; when entered manually, the spread and cards can be selected from a list, or an image can be scanned.  A history of all reading can be browsed, which can also be filtered and analyzed for statistical data.  Each user's readings are stored in a PostgreSQL database.

## Stack
* NextJs Frontend Webpage
* Electron Frontend Application for desktop and mobile
* NodeJs backend web server
* PostgreSQL Database
* Docker containers for web frontend, nodejs backend, postgres db

## Database Schema
### Readings
* readings_key
* users_key
* spread_key
* readings_time

### ReadingsShare
* readshare_key
* readings_key
* users_key
* users_shared_key

### ReadingCards
* readcard_key
* readings_key
* cards_key

### Notes
* notes_key
* readings_key
* users_key
* notes_time
* notes_text

### Impressions
* impr_key
* readings_key
* users_key
* impr_time
* imprtag_key

### ImpressionTags
* impr_key
* impr_tag

### Cards
* cards_key
* cards_suite
* cards_number

### CardMeanings
* meaning_key
* cards_key
* users_key
* meaning_text

### CardTags
* cardtags_key
* cardtags_tag

### CardTagLink
* cards_key
* users_key
* cardtags_key

### CardSkins
* cardskin_key
* cards_key
* cards_image_key

### Users
* users_key
* users_id
* users_email
* users_name
* users_role
* users_password
* users_state - Active, Pending, Disabled

### UsersSessions
* session_key
* users_key
* session_time_start
* session_last_activity
* session_location - IP+clientid

### UserTiles
* tiles_key
* users_key
* tiles_config - Json with the current tiles config.

### Messages
* msg_key
* users_key_src
* users_key_dest
* readings_key
* msg_time
* msg_read
* msg_text

## Backend Web Server
The backend webserver provides webapi services for user management, login, spread entry, and spread queries.

### Open Web Apis
Webapis which do not require a user.

#### /users/register
#### /users/login
#### /users/forgot_password
#### /status

### User Web Apis
User webapis are ones which only apply to normal users, and which use the user token to pick which user key to use when performing actions in the database.

#### /users/logout
#### /users/deactivate
#### /users/info
#### /users/settings
#### /users/tiles
Update the home tiles configuration for the user.

#### /reading/create
#### /reading/edit
#### /reading/share
#### /reading/delete
#### /reading/analyze_image

#### /reading/list
#### /reading/read
* Url Params
  * key - (string)|'last'
#### /reading/impressions
* Url Params
  * key - (string)
#### /reading/stats
* Url Params
  * type - [basic|card_count]
  * limit - (int)
  * range - [month]
#### /reading/stats/cards
* Url Params
  * limit - (int)
  * range - [month]

#### /msgs/list
* Url Params
  * type - [count|list]
  * filter - [unread|all]
#### /msgs/users
* Url Params
  * sort - [recent|count]
  * limit - (number)
  * type - [unread|all]
#### /msgs/user/{uid}


### Admin Web Apis
Admin webapis are ones which only apply to admin users, and do not directly interact with readings.

#### /users/list
#### /users/disable
#### /users/info/{uid}
#### /users/settings/{uid}


### User Management
* User login checks that the id provided matches the provide password.  The password is salted with a key file in the webserver private directory, and encrypted, before being compared to the password in the database.  If the compare matches, then a user session is created.
* The Web server uses the usersessions table to manage logged in users.  When a user logs in, an entry is created in the sessions table, and any other session for that user with the same session_location is removed.  The generated session_key is then returned for session lookups.
* The web server keeps a local memory copy of the session table for fast session lookup.
  * The cache should be refreshed at least every 5 minutes.  All sessions which exceed the duration timeouts should automatically be deleted.
  * Session login and logout should update the session db automatically.
* Every user api requires the session token be provided, which is compared against the session cache.  If it is found, and interval since session start is under max_session_duration, and the interval since session last activity is under min_session_activity_duration, then the action is allowed.  If over, the api should return a session timeout message.
* The logout command should remove the session that matches the session key.



## UI
The UI is similar for both NextJs website and Electron Application, only the layout differs.  There are 3 ui interfaces:
* Login
* User Dashboard
* Admin Dashboard

### Login
The root page when first accessing the system, providing login, about, user registration, and user recovery.  Only the web code for the login page should be returned; none of the user dashboard or admin dashboard html or js should be returned.

#### Page - Home
Root page, with a panel in the center to show the selected tile, defaulted to the login tile, and the app title at the top.  An about link is displayed at the bottom, as is application version and status.

#### Tile - Login
Displays a username and password entry box, with links for create account and forgot account below, and a login button.
* On login, /users/login is sent to the server.
  * If the response is success, go to the user or admin dashboard, depending on user type.
  * If the response is failed, display invalid credentials, and stay on the login tile.

#### Tile - Create Account
Displays a user create form, with user id, email, and password entry, and a submit below.  Password is required to be strong before submit.  
* On submit, the /users/register api is sent to the server.
  * If the response is success, go to the login screen.
  * If the response is failed, display error, and stay on the create account tile.
* A back link returns to the login screen.

#### Tile - Forgot Account
Displays a email or user entry box, with a submit button.
* Submit sends the entered email or user to the /users/forgot_password api, and displays a message that an email was sent to the associated user.
* A back link returns to the login screen.

#### Tile - About
Displays information about the application.  A back link returns to the login screen.

### User Dashboard
The User Dashboard provides an interface the user can use to view their readings, create new ones, and analyze the history and statistics of those readings.

#### Bar - Info
A bar always displayed on the bottom of the screen, providing info to the user.
* Number of readings recorded.  Hover to show popup - recent readings.
* Most common card.  Hover to show popup - stats.
* Unread Messages.  Hover to show popup - msgs.

#### Bar - Menu
A bar always displayed on the left side of the screen, allowing access to different pages.
* Hide/show arrow allows expanding or collapsing the menu bar.
* Displays links to the following pages:
  * Home
  * Create Reading
  * Reading History
  * Reading Statistics
  * User Settings
  * Logout - Logs the user out, sending /users/logout, and returns to the Login Ui.

#### Popup - Stats
A popup box which displays basic statistics about the user's readings.  Use /reading/stats?type=basic to retrieve.
* Top 5 cards by frequency in the last 2 months.
* Top 3 impression tags in the last 2 months.

#### Popup - Msgs
A popup box which displays a count of unread messages, and a short summary of the most recent from 3 users.
* Use /msgs/list?type=count&filter=unread to get a count of all unread msgs.
* Use /msgs/users?sort=recent&limit=3&type=summary for recent msg summaries.

#### Popup - Recent Readings
A popup box which displays the most recent 3 readings.
* Use /reading/list?count=3&sort=recent to get the list.
* Display each reading sorted by time.
* Each reading should display when, spread type, cards (limit 5), and tags (limit 2).

#### Page - Home
Home dashboard for users, displaying a list of configurable tiles.
* Tiles are rearrangable in a grid.  The grid is in a scrollable container, allowing any number of tiles to be loaded.
* Tiles are arranged toward the top of the grid, with the last 'empty' tile represented by a '+' image, allowing the user to add a tile.
* Each tile has a 'change' icon, and a 'remove' icon, at the top right.
  * Change - Provides a dropdown to select from the list of home tiles
  * Remove - Removes the tile, and resorts the other tiles.
* The top of each tile has the title of the tile, and can be dragged.  If it is dragged into the grid cell of another tile, it is moved to that position, and all the cells before and after are moved up or down to make space.
* Each tile is the same size, with a ratio of 4:3 width:height.
* Tiles Supported
  * Last Reading
  * Reading Trends
  * Reading Most Common
  * Reading History
  * Shared Readings
  * Recent Messages
  * Quick Reading

#### Tile - Last Reading
Displays a graphical spread of the last reading done, the date, and the impression tags associated.  If there is a reading note, displays a truncated version at the bottom.  The top right lists the count of notes attached to it.
* Update data using /reading/read?key=last

#### Tile - Reading Trends

#### Tile - Reading Most Common
Displays the top 5 most common cards over the last month in a grid.  Column for card name, frequency this week, frequency this month, frequency last month.  Uses /reading/stats/cards?limit=5&range=month to query.

#### Tile - Reading History
Grid list of readings, showing the last 5 readings as rows.  Columns are date of reading, first 3 cards as mini card images, and first 2 readings tags if any, or short summary of readings notes if no tags are available.

#### Tile - Shared Readings

#### Tile - Recent Messages

#### Tile - Quick Reading
Displays a 3 card past-present-future spread, face down.  A Read button is at the bottom, which generates and displays all 3 cards, or the user can click on each card to reveal one by one.  Once revealed, a Save button replaces the Read button, which when clicked saves the reading as the latest, and goes to the reading edit page for this reading.

#### Page - Reading Create
Page to create a new reading.
* A list of reading types are along the left side, displayed as graphical images of the spreads;  hovering displays a popup with the name, and a brief description of what the spread is used for.
* Clicking a reading type displays the spread in the center, with all cards face down, using the user's selected card theme for the image.  
* On the right of the screen is an impressions panel.

#### Panel - Impressions
Displays impressions and tags for a reading, and allows adding new ones.
* Vertical panel, with a dynamic list of impressions running downwards.  Each impression has a timestamp of when it was made, the user that made it, and the text of the impression.
* A text box displays a list of tags, each of which is a clickable rectangle, with a X on the right to remove.
* A + button at the top right of the tag box allows adding a new tag.
* A + button at the top right of the impression list shows a text box to enter a new impression.  Clicking ctl+enter, or clicking the small Save button at the bottom right of the box saves the impression to the list.
* Uses 

#### Page - Card Lookup

#### Page - Reading History Grid
Grid list of readings, displayed either as rows of readings with details, or tiles with snapshots.  A toggle switch on the top bar allows switching betwen the two.
* Row Mode - Displays 4 columns, with each row being a reading.  Clicking the column header sorts the readings by that column.  The columns are:
  * Date of Reading
  * First 3 cards of reading as mini card images.  Clicking the cards goes to Page - Reading View.
  * Short summary of reading notes
  * First 3 reading tags.

#### Page - Reading View
Displays a reading and the attached notes.  The cards are displayed as images in the top center, arranged according to the spread type, and using the user's selected image theme.  The date of the reading is shown at the top, and the list of impressions and tags are displayed using the impressions panel to the right.
* Use /reading/read?key={key} to get the reading info to display.

#### Page - Reading Statistics

#### Page - User Settings


### Admin Dashboard
The admin dashboard provides an interface for administrators to view and manage the system as a whole, including managing users, moderating messages and readings, and managing the servers.

#### Bar - Menu

#### Page - Home

#### Tile - Users Stats

#### Tile - Server Stats

#### Page - Users

#### Tile - Users List

#### Tile - Users Edit

* reset password
* enable/disable/activate user
* send msg

#### Page - Messages

#### Tile - Messages List

#### Tile - Message View

#### Tile - Message Stats

#### Page - Servers

#### Tile - Database Stats

#### Tile - Web Server Stats

#### Tile - Users Cache



## Phases
### Phase 1
* Webapi Backend server, limited to the following apis
  * #### /users/login
  * #### /status
  * #### /users/logout
  * #### /users/info
  * #### /users/settings
  * #### /users/list
  * #### /reading/create
  * #### /reading/edit
  * #### /reading/delete
  * #### /reading/list
  * #### /reading/read
  * #### /reading/impressions
* Postgresql db server
* sample js scripts to test api
  * create readings
  * list readings
  * get reading
  * delete reading
* sample js scripts to init the db
  * create tables
  * clear tables
  * delete tables
  * create user
  * execute sql statement

### Phase 2
* Regular user only Frontend Web Server, limited to the following pages and tiles
  * Page - Home
  * Bar - Menu
  * Bar - Info
  * Tile - Last Reading
  * Tile - Reading History
  * Page - Create Reading
  * Page - Reading History
  * Panel - Impressions

### Phase 3 - Admin Dashboard
* Add the Admin Dashboard elements to the Frontend Web Server
  * Bar - Menu
  * Page - Home
  * Tile - Users Stats
  * Tile - Server Stats
  * Page - Users
  * Tile - Users List
* Add the admin cmds to the backend nodejs server
  * /users/list
  * /users/info/{uid} 

### Phase 4 - Messages
* Add message support to the backend api
* Add message support to the user ui
* Add message support to the admin ui